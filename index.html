<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS App Mode Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SG Radar">
    
    <!-- Favicon and Apple Touch Icon (Solid Background for iOS Support) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiB2aWV3Qm94PSIwIDAgMTgwIDE4MCI+CiAgPHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIGZpbGw9IiMwZjE3MmEiIC8+CiAgPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2Utb3BhY2l0eT0iMC4zIiBkPSJNNDUgMTM1IEMgNDUgNDUsIDEzNSAxMzUsIDEzNSA0NSIgLz4KICA8Y2lyY2xlIGN4PSI0NSIgY3k9IjEzNSIgcj0iMTIiIGZpbGw9IndoaXRlIiAvPgogIDxjaXJjbGUgY3g9IjEzNSIgY3k9IjQ1IiByPSIxNSIgZmlsbD0iI0Y5NzMxNiIgLz4KPC9zdmc+">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiB2aWV3Qm94PSIwIDAgMTgwIDE4MCI+CiAgPHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIGZpbGw9IiMwZjE3MmEiIC8+CiAgPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2Utb3BhY2l0eT0iMC4zIiBkPSJNNDUgMTM1IEMgNDUgNDUsIDEzNSAxMzUsIDEzNSA0NSIgLz4KICA8Y2lyY2xlIGN4PSI0NSIgY3k9IjEzNSIgcj0iMTIiIGZpbGw9IndoaXRlIiAvPgogIDxjaXJjbGUgY3g9IjEzNSIgY3k9IjQ1IiByPSIxNSIgZmlsbD0iI0Y5NzMxNiIgLz4KPC9zdmc+">
    
    <title>SG Moto Rain Radar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        #map { height: 100vh; width: 100%; background-color: #020617; }
        
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .radar-layer { 
            filter: saturate(2.5) brightness(1.3) contrast(1.2); 
            z-index: 400; 
            pointer-events: none;
        }
        
        .marker-container { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .marker-glow { filter: drop-shadow(0 0 6px currentColor); font-size: 22px; }
        .marker-label {
            font-size: 10px; font-weight: 900; color: white; text-transform: uppercase;
            letter-spacing: 0.5px; text-shadow: 0 0 4px rgba(0,0,0,1), 0 0 2px rgba(0,0,0,1);
            margin-top: -2px;
        }

        .user-dot { 
            width: 14px; height: 14px; 
            background-color: #3b82f6; 
            border: 2px solid white; 
            border-radius: 50%; 
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.8); 
            position: relative;
        }
        .user-dot::after {
            content: ''; position: absolute; top: -1px; left: -1px;
            width: 100%; height: 100%; border-radius: 50%;
            border: 2px solid #3b82f6; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }

        .btn-active:active { transform: scale(0.92); filter: brightness(1.2); }
        .traffic-layer { filter: saturate(1.8) contrast(1.2) brightness(0.8); z-index: 10; }
        
        @keyframes cam-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .cam-on-route { animation: cam-pulse 1.5s infinite; color: #f87171 !important; font-size: 16px !important; }
        .camera-marker { filter: drop-shadow(0 0 2px rgba(0,0,0,1)); pointer-events: auto; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans min-h-screen flex flex-col overflow-hidden">

    <div class="relative flex-grow h-full">
        <div id="map"></div>
        
        <!-- Controls -->
        <div class="absolute top-4 right-4 z-[500] flex flex-col gap-3" style="padding-top: var(--safe-top);">
            <button onclick="locateUser()" id="locate-btn" class="bg-slate-800/90 backdrop-blur text-white w-12 h-12 flex items-center justify-center rounded-xl shadow-2xl btn-active border border-white/10" title="Locate Me">
                <i class="fas fa-location-arrow"></i>
            </button>
            <button onclick="toggleView()" id="view-btn" class="bg-slate-800/90 backdrop-blur text-white w-12 h-12 flex items-center justify-center rounded-xl shadow-2xl btn-active border border-white/10" title="Toggle Zoom Level">
                <i id="view-icon" class="fas fa-route"></i>
            </button>
            <button onclick="toggleTraffic()" id="traffic-btn" class="bg-slate-800/90 backdrop-blur text-white w-12 h-12 flex items-center justify-center rounded-xl shadow-2xl btn-active border border-white/10" title="Traffic Layer">
                <i class="fas fa-car"></i>
            </button>
            <button onclick="toggleCameras()" id="cam-btn" class="bg-slate-800/90 backdrop-blur text-slate-300 w-12 h-12 flex items-center justify-center rounded-xl shadow-2xl btn-active border border-white/10" title="Speed Cameras">
                <i class="fas fa-camera"></i>
            </button>
            <button onclick="manualRefresh()" id="refresh-btn" class="bg-slate-800/90 backdrop-blur text-white w-12 h-12 flex items-center justify-center rounded-xl shadow-2xl btn-active border border-white/10" title="Refresh">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <!-- Legend -->
        <div class="absolute left-4 bg-slate-950/90 p-4 rounded-2xl border border-white/10 text-[10px] shadow-2xl z-[500] backdrop-blur-md" style="bottom: calc(1.5rem + var(--safe-bottom)); min-width: 140px;">
            <div class="flex justify-between items-center mb-3 border-b border-white/5 pb-1">
                <div class="font-black text-slate-400 uppercase tracking-widest text-[8px]">Rain Intensity</div>
                <div id="radar-time-banner" class="font-black text-emerald-400 text-[8px]">--:--</div>
            </div>
            <div class="grid grid-cols-2 gap-x-6 gap-y-2">
                <div class="flex items-center gap-2">
                    <div class="w-3.5 h-3.5 rounded-md" style="background:#00FD00"></div> <span>Light</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3.5 h-3.5 rounded-md" style="background:#FDFD00"></div> <span>Mod</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3.5 h-3.5 rounded-md" style="background:#FD0000"></div> <span>Heavy</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3.5 h-3.5 rounded-md" style="background:#FD00FD"></div> <span>Ext</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const LOCATIONS = {
            home: { lat: 1.3163, lng: 103.8045, name: "HOME" },
            work: { lat: 1.2998, lng: 103.7883, name: "OFFICE" }
        };

        const SG_CENTER = [1.3521, 103.8198];
        const RADAR_BOUNDS = [[1.16, 103.58], [1.47, 104.10]];
        const CAM_DATA_ID = "d_983804de2bc016f53e44031d85d1ec8a";

        let map, radarOverlay, trafficLayer, camLayer, userLocationMarker, routePolyline;
        let isTrafficOn = false, isCamsOn = false, isWholeSGView = false;

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            fetchRoute().then(() => fetchSpeedCameras());
            updateRadar();
            setInterval(updateRadar, 60000);
        });

        function initMap() {
            map = L.map('map', { 
                center: SG_CENTER, 
                zoom: 12, 
                minZoom: 11,
                maxBounds: RADAR_BOUNDS,
                maxBoundsViscosity: 1.0, 
                zoomControl: false, 
                attributionControl: false 
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

            trafficLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=m,traffic&x={x}&y={y}&z={z}', {
                maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], opacity: 0, className: 'traffic-layer'
            }).addTo(map);

            camLayer = L.layerGroup();

            L.marker([LOCATIONS.home.lat, LOCATIONS.home.lng], {
                icon: L.divIcon({ 
                    html: `<div class="marker-container"><i class="fas fa-house-chimney marker-glow text-emerald-400"></i><div class="marker-label">${LOCATIONS.home.name}</div></div>`, 
                    iconSize: [60, 40], iconAnchor: [30, 35], className: ''
                })
            }).addTo(map);

            L.marker([LOCATIONS.work.lat, LOCATIONS.work.lng], {
                icon: L.divIcon({ 
                    html: `<div class="marker-container"><i class="fas fa-briefcase marker-glow text-orange-400"></i><div class="marker-label">${LOCATIONS.work.name}</div></div>`, 
                    iconSize: [60, 40], iconAnchor: [30, 35], className: ''
                })
            }).addTo(map);
        }

        async function fetchRoute() {
            const url = `https://router.project-osrm.org/route/v1/driving/${LOCATIONS.home.lng},${LOCATIONS.home.lat};${LOCATIONS.work.lng},${LOCATIONS.work.lat}?overview=full&geometries=geojson`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.routes?.[0]) {
                    const geojson = data.routes[0].geometry;
                    routePolyline = geojson.coordinates.map(c => [c[1], c[0]]);
                    L.geoJSON(geojson, { style: { color: '#6366f1', weight: 6, opacity: 0.3 } }).addTo(map);
                    map.fitBounds(L.latLngBounds(routePolyline), { padding: [60, 60] });
                    return true;
                }
            } catch (e) { console.error("Route failed", e); }
            return false;
        }

        async function fetchSpeedCameras() {
            try {
                const response = await fetch(`https://data.gov.sg/api/action/datastore_search?resource_id=${CAM_DATA_ID}&limit=200`);
                const data = await response.json();
                data.result.records.forEach(cam => {
                    const lat = parseFloat(cam.location_latitude), lng = parseFloat(cam.location_longitude);
                    if (isNaN(lat) || isNaN(lng)) return;
                    let onRoute = false;
                    if (routePolyline) {
                        for(let pt of routePolyline) {
                            if (map.distance([lat, lng], pt) < 500) { onRoute = true; break; }
                        }
                    }
                    const markerClass = onRoute ? 'cam-on-route' : '';
                    L.marker([lat, lng], {
                        icon: L.divIcon({ html: `<i class="fas fa-camera text-red-500/80 text-xs camera-marker ${markerClass}"></i>`, iconSize: [16, 16], className: '' })
                    }).bindPopup(`<div class="text-[10px] text-slate-900 leading-tight"><div class="font-black uppercase text-red-600 mb-1">${cam.type_of_speed_camera || 'Speed Camera'}</div><div class="font-bold">${cam.location}</div>${onRoute ? '<div class="mt-1 text-red-500 font-black">⚠️ ON YOUR ROUTE</div>' : ''}</div>`).addTo(camLayer);
                });
            } catch (e) { console.error("Camera data failed", e); }
        }

        function manualRefresh() { location.reload(); }

        function locateUser() {
            if (!navigator.geolocation) return;
            const btn = document.getElementById('locate-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude, lng = position.coords.longitude;
                    if (userLocationMarker) map.removeLayer(userLocationMarker);
                    userLocationMarker = L.marker([lat, lng], {
                        icon: L.divIcon({ html: '<div class="user-dot"></div>', iconSize: [14, 14], className: '' })
                    }).addTo(map);
                    map.flyTo([lat, lng], 15);
                    btn.innerHTML = '<i class="fas fa-location-arrow text-blue-400"></i>';
                },
                () => { btn.innerHTML = '<i class="fas fa-location-arrow"></i>'; },
                { enableHighAccuracy: true }
            );
        }

        function toggleView() {
            isWholeSGView = !isWholeSGView;
            const icon = document.getElementById('view-icon');
            const btn = document.getElementById('view-btn');
            if (isWholeSGView) {
                map.fitBounds(RADAR_BOUNDS);
                icon.className = 'fas fa-map';
                btn.classList.add('bg-blue-600');
            } else {
                if (routePolyline) map.fitBounds(L.latLngBounds(routePolyline), { padding: [60, 60] });
                icon.className = 'fas fa-route';
                btn.classList.remove('bg-blue-600');
            }
        }

        async function updateRadar() {
            const timeBanner = document.getElementById('radar-time-banner');
            const now = new Date();
            for (let offset = 0; offset < 3; offset++) {
                const checkTime = new Date(Math.floor((now.getTime() - (offset * 300000)) / 300000) * 300000);
                const ts = checkTime.getFullYear() + String(checkTime.getMonth() + 1).padStart(2, '0') + String(checkTime.getDate()).padStart(2, '0') + String(checkTime.getHours()).padStart(2, '0') + String(checkTime.getMinutes()).padStart(2, '0');
                const radarUrl = `https://www.weather.gov.sg/files/rainarea/50km/v2/dpsri_70km_${ts}0000dBR.dpsri.png`;
                const success = await new Promise((r) => { const i = new Image(); i.onload = () => r(true); i.onerror = () => r(false); i.src = radarUrl; });
                if (success) {
                    if (radarOverlay) map.removeLayer(radarOverlay);
                    radarOverlay = L.imageOverlay(radarUrl, RADAR_BOUNDS, { opacity: 0.5, className: 'radar-layer' }).addTo(map);
                    timeBanner.innerText = checkTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    timeBanner.classList.replace('text-red-500', 'text-emerald-400');
                    return;
                }
            }
            timeBanner.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            timeBanner.classList.replace('text-emerald-400', 'text-red-500');
        }

        function toggleTraffic() {
            isTrafficOn = !isTrafficOn;
            trafficLayer.setOpacity(isTrafficOn ? 0.6 : 0);
            const btn = document.getElementById('traffic-btn');
            btn.classList.toggle('bg-blue-600', isTrafficOn);
            btn.classList.toggle('bg-slate-800', !isTrafficOn);
        }

        function toggleCameras() {
            isCamsOn = !isCamsOn;
            if (isCamsOn) map.addLayer(camLayer); else map.removeLayer(camLayer);
            const btn = document.getElementById('cam-btn');
            btn.classList.toggle('bg-red-900', isCamsOn);
            btn.classList.toggle('bg-slate-800', !isCamsOn);
            btn.classList.toggle('text-white', isCamsOn);
        }
    </script>
</body>
</html>
