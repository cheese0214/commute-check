<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS App Mode Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SG Radar">
    
    <!-- Custom iOS Home Screen Icon (SVG Base64) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiB2aWV3Qm94PSIwIDAgMTgwIDE4MCI+CiAgPHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIHJ4PSIzNiIgZmlsbD0iIzAyMDYxNyIvPgogIDxnIG9wYWNpdHk9IjAuNSI+CiAgICA8Y2lyY2xlIGN4PSI5MCIgY3k9IjkwIiByPSI3MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNmI3MjgwIiBzdHJva2Utd2lkdGg9IjAuNSIvPgogICAgPGNpcmNsZSBjeD0iOTAiIGN5PSI5MCIgcj0iNTAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzZiNzI4MCIgc3Ryb2tlLXdpZHRoPSIwLjUiLz4KICA8L2c+CiAgPHBhdGggZD0iTTkwIDIwdjgwbTQwLTMwTDUwIDEzMCIgc3Ryb2tlPSIjMTBlYjcxIiBzdHJva2Utd2lkdGg9IjEiIHN0cm9rZS1vcGFjaXR5PSIwLjMiLz4KICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg0NSwgNDUpIHNjYWxlKDUuNikiPgogICAgPHBhdGggZmlsbD0iIzEwZWI3MSIgZD0iTTE4LjgsMTUuNUMxOC4xLDE0LjcgMTcuMiwxNC4zIDE2LjIsMTQuM0gxNC41TDExLjgsOUMxMS41LDguMiAxMC43LDcuNyA5LjgsNy43SDUuOFY2LjdDOC4zLDYuNyAxMC4zLDQuNyAxMC4zLDIuMkMxMC4zLDAuNyA5LjEsLTAuNSA3LjYsLTAuNVM0LjksMC43IDQuOSwyLjJDNC45LDMuOSA2LDQuOSA3LjMsNi4yVjcuN0gyLjVDMS43LDcuNyAxLDguNCAxLDkuMlYxMS43SDAuNVYxMy4ySDFWMTQuM0MwLjQsMTQuMyAwLDE0LjcgMCwxNS41QzAsMTYuMyAwLjQsMTYuNyAxLDE2LjdIMTguOEMxOS40LDE2LjcgMTkuOCwxNi4zIDE5LjgsMTUuNUMxOS44LDE0LjcgMTkuNCwxNC4zIDE4LjgsMTUuNU03LjYsMC44QzguNCwwLjggOC45LDEuNCA4LjksMi4yQzguOSwyLjkgOC40LDMuNSA3LjYsMy41QzYuOCwzLjUgNi4zLDIuOSA2LjMsMi4yQzYuMywxLjQgNi44LDAuOCA3LjYsMC44WiIgLz4KICA8L2c+Cjwvc3ZnPg==">
    
    <title>SG Moto Rain Radar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        #map { height: calc(100vh - 110px - var(--safe-top)); width: 100%; background-color: #020617; }
        
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .radar-layer { 
            filter: saturate(2.5) brightness(1.3) contrast(1.2); 
            z-index: 400; 
            pointer-events: none;
        }
        
        .marker-container { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .marker-glow { filter: drop-shadow(0 0 6px currentColor); font-size: 22px; }
        .marker-label {
            font-size: 10px; font-weight: 900; color: white; text-transform: uppercase;
            letter-spacing: 0.5px; text-shadow: 0 0 4px rgba(0,0,0,1), 0 0 2px rgba(0,0,0,1);
            margin-top: -2px;
        }

        .user-dot { 
            width: 14px; height: 14px; 
            background-color: #3b82f6; 
            border: 2px solid white; 
            border-radius: 50%; 
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.8); 
            position: relative;
        }
        .user-dot::after {
            content: ''; position: absolute; top: -1px; left: -1px;
            width: 100%; height: 100%; border-radius: 50%;
            border: 2px solid #3b82f6; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }

        .btn-active:active { transform: scale(0.92); filter: brightness(1.2); }

        .traffic-layer { filter: saturate(1.8) contrast(1.2) brightness(0.8); z-index: 10; }
        
        @keyframes pulse-alert {
            0%, 100% { background-color: #450a0a; }
            50% { background-color: #7f1d1d; }
        }
        .rain-alert-active { animation: pulse-alert 2s infinite; }
        
        @keyframes cam-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .cam-on-route { animation: cam-pulse 1.5s infinite; color: #f87171 !important; font-size: 16px !important; }
        .camera-marker { filter: drop-shadow(0 0 2px rgba(0,0,0,1)); pointer-events: auto; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans min-h-screen flex flex-col overflow-hidden">

    <div id="status-card" class="bg-slate-900 border-b border-slate-800 shadow-xl z-20 transition-all duration-500" style="padding-top: calc(1rem + var(--safe-top)); padding-left: 1rem; padding-right: 1rem; padding-bottom: 1rem;">
        <div class="max-w-md mx-auto flex items-center gap-4">
            <div id="status-icon" class="text-3xl w-10 flex justify-center text-emerald-400">
                <i class="fas fa-motorcycle"></i>
            </div>
            <div class="flex-grow flex items-center justify-between gap-4">
                <div>
                    <h1 class="text-[9px] font-bold uppercase tracking-widest text-slate-500 mb-0.5">Commute Weather</h1>
                    <h2 id="status-text" class="text-lg font-black text-white leading-tight">Checking Route...</h2>
                    <p id="status-sub" class="text-slate-400 text-[10px]">Home ↔ Office path scan</p>
                </div>
                <div id="radar-time-banner" class="text-[9px] font-black text-slate-400 bg-slate-800 px-2 py-1.5 rounded border border-slate-700 whitespace-nowrap self-center">
                    RADAR: --
                </div>
            </div>
        </div>
    </div>

    <div class="relative flex-grow">
        <div id="map"></div>
        
        <!-- Controls: Compact Icon-only Grid -->
        <div class="absolute top-4 right-4 z-[500] flex flex-col gap-3">
            <button onclick="locateUser()" id="locate-btn" class="bg-slate-800/90 backdrop-blur text-white w-12 h-12 flex items-center justify-center rounded-xl shadow-2xl btn-active border border-white/10" title="Locate Me">
                <i class="fas fa-location-arrow"></i>
            </button>
            <button onclick="toggleView()" id="view-btn" class="bg-slate-800/90 backdrop-blur text-white w-12 h-12 flex items-center justify-center rounded-xl shadow-2xl btn-active border border-white/10" title="Toggle Zoom Level">
                <i id="view-icon" class="fas fa-route"></i>
            </button>
            <button onclick="toggleTraffic()" id="traffic-btn" class="bg-slate-800/90 backdrop-blur text-white w-12 h-12 flex items-center justify-center rounded-xl shadow-2xl btn-active border border-white/10" title="Traffic Layer">
                <i class="fas fa-car"></i>
            </button>
            <button onclick="toggleCameras()" id="cam-btn" class="bg-slate-800/90 backdrop-blur text-slate-300 w-12 h-12 flex items-center justify-center rounded-xl shadow-2xl btn-active border border-white/10" title="Speed Cameras">
                <i class="fas fa-camera"></i>
            </button>
        </div>

        <!-- Legend: Adjusted for Home Bar -->
        <div class="absolute left-4 bg-slate-950/90 p-4 rounded-2xl border border-white/10 text-[10px] shadow-2xl z-[500] backdrop-blur-md" style="bottom: calc(1.5rem + var(--safe-bottom));">
            <div class="font-black mb-3 text-slate-400 uppercase tracking-widest border-b border-white/5 pb-1 text-[8px]">Rain Intensity</div>
            <div class="grid grid-cols-2 gap-x-6 gap-y-2">
                <div class="flex items-center gap-2">
                    <div class="w-3.5 h-3.5 rounded-md" style="background:#00FD00"></div> <span>Light</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3.5 h-3.5 rounded-md" style="background:#FDFD00"></div> <span>Mod</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3.5 h-3.5 rounded-md" style="background:#FD0000"></div> <span>Heavy</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3.5 h-3.5 rounded-md" style="background:#FD00FD"></div> <span>Ext</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const LOCATIONS = {
            home: { lat: 1.3163, lng: 103.8045, name: "HOME" },
            work: { lat: 1.2998, lng: 103.7883, name: "OFFICE" }
        };

        const SG_CENTER = [1.3521, 103.8198];
        const RADAR_BOUNDS = [[1.16, 103.58], [1.47, 104.10]];
        const CAM_DATA_ID = "d_983804de2bc016f53e44031d85d1ec8a";

        let map, radarOverlay, trafficLayer, camLayer, radarImage, userLocationMarker, routePolyline;
        let isTrafficOn = false, isCamsOn = false, isWholeSGView = false;

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            fetchRoute().then(() => fetchSpeedCameras());
            updateRadar();
            setInterval(updateRadar, 150000); 
        });

        function initMap() {
            map = L.map('map', { 
                center: SG_CENTER, 
                zoom: 12, 
                minZoom: 11,
                maxBounds: RADAR_BOUNDS,
                maxBoundsViscosity: 1.0, 
                zoomControl: false, 
                attributionControl: false 
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

            trafficLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=m,traffic&x={x}&y={y}&z={z}', {
                maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], opacity: 0, className: 'traffic-layer'
            }).addTo(map);

            camLayer = L.layerGroup();

            L.marker([LOCATIONS.home.lat, LOCATIONS.home.lng], {
                icon: L.divIcon({ 
                    html: `<div class="marker-container"><i class="fas fa-house-chimney marker-glow text-emerald-400"></i><div class="marker-label">${LOCATIONS.home.name}</div></div>`, 
                    iconSize: [60, 40], iconAnchor: [30, 35], className: ''
                })
            }).addTo(map);

            L.marker([LOCATIONS.work.lat, LOCATIONS.work.lng], {
                icon: L.divIcon({ 
                    html: `<div class="marker-container"><i class="fas fa-briefcase marker-glow text-orange-400"></i><div class="marker-label">${LOCATIONS.work.name}</div></div>`, 
                    iconSize: [60, 40], iconAnchor: [30, 35], className: ''
                })
            }).addTo(map);
        }

        async function fetchRoute() {
            const url = `https://router.project-osrm.org/route/v1/driving/${LOCATIONS.home.lng},${LOCATIONS.home.lat};${LOCATIONS.work.lng},${LOCATIONS.work.lat}?overview=full&geometries=geojson`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.routes?.[0]) {
                    const geojson = data.routes[0].geometry;
                    routePolyline = geojson.coordinates.map(c => [c[1], c[0]]);
                    L.geoJSON(geojson, { style: { color: '#6366f1', weight: 6, opacity: 0.3 } }).addTo(map);
                    map.fitBounds(L.latLngBounds(routePolyline), { padding: [60, 60] });
                    return true;
                }
            } catch (e) { console.error("Route failed", e); }
            return false;
        }

        async function fetchSpeedCameras() {
            try {
                const response = await fetch(`https://data.gov.sg/api/action/datastore_search?resource_id=${CAM_DATA_ID}&limit=200`);
                const data = await response.json();
                data.result.records.forEach(cam => {
                    const lat = parseFloat(cam.location_latitude), lng = parseFloat(cam.location_longitude);
                    if (isNaN(lat) || isNaN(lng)) return;
                    let onRoute = false;
                    if (routePolyline) {
                        for(let pt of routePolyline) {
                            if (map.distance([lat, lng], pt) < 500) { onRoute = true; break; }
                        }
                    }
                    const markerClass = onRoute ? 'cam-on-route' : '';
                    L.marker([lat, lng], {
                        icon: L.divIcon({ html: `<i class="fas fa-camera text-red-500/80 text-xs camera-marker ${markerClass}"></i>`, iconSize: [16, 16], className: '' })
                    }).bindPopup(`<div class="text-[10px] text-slate-900 leading-tight"><div class="font-black uppercase text-red-600 mb-1">${cam.type_of_speed_camera || 'Speed Camera'}</div><div class="font-bold">${cam.location}</div>${onRoute ? '<div class="mt-1 text-red-500 font-black">⚠️ ON YOUR ROUTE</div>' : ''}</div>`).addTo(camLayer);
                });
            } catch (e) { console.error("Camera data failed", e); }
        }

        function locateUser() {
            if (!navigator.geolocation) return;
            const btn = document.getElementById('locate-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude, lng = position.coords.longitude;
                    if (userLocationMarker) map.removeLayer(userLocationMarker);
                    userLocationMarker = L.marker([lat, lng], {
                        icon: L.divIcon({ html: '<div class="user-dot"></div>', iconSize: [14, 14], className: '' })
                    }).addTo(map);
                    map.flyTo([lat, lng], 15);
                    btn.innerHTML = '<i class="fas fa-location-arrow text-blue-400"></i>';
                },
                () => { btn.innerHTML = '<i class="fas fa-location-arrow"></i>'; },
                { enableHighAccuracy: true }
            );
        }

        function toggleView() {
            isWholeSGView = !isWholeSGView;
            const icon = document.getElementById('view-icon');
            const btn = document.getElementById('view-btn');
            if (isWholeSGView) {
                map.fitBounds(RADAR_BOUNDS);
                icon.className = 'fas fa-map';
                btn.classList.add('bg-blue-600');
            } else {
                if (routePolyline) map.fitBounds(L.latLngBounds(routePolyline), { padding: [60, 60] });
                icon.className = 'fas fa-route';
                btn.classList.remove('bg-blue-600');
            }
        }

        async function updateRadar() {
            const now = new Date();
            const rounded = new Date(Math.floor(now.getTime() / 300000) * 300000);
            const ts = rounded.getFullYear() + String(rounded.getMonth() + 1).padStart(2, '0') + String(rounded.getDate()).padStart(2, '0') + String(rounded.getHours()).padStart(2, '0') + String(rounded.getMinutes()).padStart(2, '0');
            const radarUrl = `https://www.weather.gov.sg/files/rainarea/50km/v2/dpsri_70km_${ts}0000dBR.dpsri.png`;

            if (radarOverlay) map.removeLayer(radarOverlay);
            radarOverlay = L.imageOverlay(radarUrl, RADAR_BOUNDS, { opacity: 0.75, className: 'radar-layer' })
                .on('load', () => setUIStatus('success', 'CLEAR FOR COMMUTE', 'No heavy rain detected on your specific route.'))
                .addTo(map);

            const timeStr = rounded.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            document.getElementById('radar-time-banner').innerText = `RADAR: ${timeStr}`;
        }

        function setUIStatus(type, title, sub) {
            const card = document.getElementById('status-card');
            const icon = document.getElementById('status-icon');
            document.getElementById('status-text').innerText = title;
            document.getElementById('status-sub').innerText = sub;
            card.classList.remove('rain-alert-active');
            if (type === 'success') { icon.innerHTML = '<i class="fas fa-motorcycle text-emerald-400"></i>'; } 
            else { card.classList.add('rain-alert-active'); icon.innerHTML = '<i class="fas fa-cloud-showers-heavy text-white"></i>'; }
        }

        function toggleTraffic() {
            isTrafficOn = !isTrafficOn;
            trafficLayer.setOpacity(isTrafficOn ? 0.6 : 0);
            const btn = document.getElementById('traffic-btn');
            btn.classList.toggle('bg-blue-600', isTrafficOn);
            btn.classList.toggle('bg-slate-800', !isTrafficOn);
        }

        function toggleCameras() {
            isCamsOn = !isCamsOn;
            if (isCamsOn) map.addLayer(camLayer); else map.removeLayer(camLayer);
            const btn = document.getElementById('cam-btn');
            btn.classList.toggle('bg-red-900', isCamsOn);
            btn.classList.toggle('bg-slate-800', !isCamsOn);
            btn.classList.toggle('text-white', isCamsOn);
        }
    </script>
</body>
</html>
